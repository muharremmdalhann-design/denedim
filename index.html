<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sızıntı | Optical Flow & Particle System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; cursor: crosshair; }
        .interface {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: rgba(0,0,0,0.85); padding: 20px; border-radius: 4px;
            color: #00ffcc; font-family: 'Courier New', monospace;
            border: 1px solid rgba(0, 255, 204, 0.3);
            pointer-events: auto;
        }
        .interface h2 { margin: 0 0 10px 0; font-size: 14px; letter-spacing: 2px; }
        input[type="file"] { color: #fff; font-size: 12px; margin-top: 10px; }
        .hint { font-size: 10px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="interface">
        <h2>> OPTICAL_FLOW_v3</h2>
        <input type="file" id="imgInput" accept="image/*">
        <div class="hint">// Hareket hızı itme gücünü belirler.</div>
    </div>

    <script>
        let video;
        let prevImg;
        let particles = [];
        let userImg;
        let imgLoaded = false;
        let vScale = 4; // Analiz çözünürlüğü (performans için)

        function setup() {
            createCanvas(windowWidth, windowHeight);
            
            // Kamera kurulumu
            video = createCapture(VIDEO);
            video.size(width / vScale, height / vScale);
            video.hide();

            // Önceki kareyi saklamak için buffer
            prevImg = createImage(video.width, video.height);

            // Başlangıç partikülleri
            for (let i = 0; i < 120; i++) {
                particles.push(new Particle());
            }

            // Fotoğraf yükleme işlemi
            document.getElementById('imgInput').addEventListener('change', function(e) {
                let file = e.target.files[0];
                if (file) {
                    let reader = new FileReader();
                    reader.onload = function(event) {
                        userImg = loadImage(event.target.result, () => {
                            imgLoaded = true;
                        });
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        function draw() {
            background(0);

            // 1. Arka Planda Kamerayı Çiz (Aynalanmış ve Tam Ekran)
            push();
            translate(width, 0);
            scale(-1, 1);
            tint(255, 80); // Seni biraz transparan yapalım
            image(video, 0, 0, width, height);
            pop();

            video.loadPixels();
            prevImg.loadPixels();

            if (video.pixels.length > 0 && prevImg.pixels.length > 0) {
                for (let p of particles) {
                    p.applyGravity();
                    
                    // Partikülün koordinatını kamera çözünürlüğüne map'le
                    let vx = floor(map(p.pos.x, 0, width, video.width, 0));
                    let vy = floor(map(p.pos.y, 0, height, 0, video.height));

                    if (vx > 0 && vx < video.width && vy > 0 && vy < video.height) {
                        let index = (vx + vy * video.width) * 4;
                        
                        // İki kare arasındaki fark (Hareket şiddeti)
                        let diff = abs(video.pixels[index] - prevImg.pixels[index]);

                        if (diff > 40) { // Hareket eşiği
                            // Çevredeki gradient (Yön tayini)
                            let nx = (vx + 1 + vy * video.width) * 4;
                            let ny = (vx + (vy + 1) * video.width) * 4;
                            
                            let dx = video.pixels[nx] - video.pixels[index];
                            let dy = video.pixels[ny] - video.pixels[index];
                            
                            let flowV = createVector(dx, dy);
                            flowV.normalize();
                            
                            // ORGANİK İTME GÜCÜ (Hareket şiddetiyle orantılı)
                            let pushStrength = map(diff, 40, 255, 15, 60); 
                            flowV.mult(-pushStrength); // Etki-tepki için ters yön
                            
                            p.applyForce(flowV);
                            p.rotationSpeed += random(-0.2, 0.2);
                        }
                    }

                    p.update();
                    p.display();
                }
            }

            // Mevcut kareyi bir sonraki döngü için sakla
            prevImg.copy(video, 0, 0, video.width, video.height, 0, 0, video.width, video.height);
        }

        class Particle {
            constructor() {
                this.init(true);
            }

            init(firstTime = false) {
                this.pos = createVector(random(width), firstTime ? random(-height, 0) : -100);
                this.vel = createVector(random(-1, 1), random(2, 5));
                this.acc = createVector(0, 0);
                this.size = random(40, 90);
                this.angle = random(TWO_PI);
                this.rotationSpeed = random(-0.02, 0.02);
            }

            applyForce(f) {
                this.acc.add(f);
            }

            applyGravity() {
                this.acc.add(createVector(0, 0.15));
            }

            update() {
                this.vel.add(this.acc);
                this.pos.add(this.vel);
                this.acc.mult(0);
                
                // Sürtünme: Havada süzülme hissi verir
                this.vel.mult(0.97); 
                
                // Dönüşü güncelle
                this.angle += this.rotationSpeed;
                this.rotationSpeed *= 0.95;

                // Ekrandan çıkarsa (alt, sağ veya sol) yeniden canlandır
                if (this.pos.y > height + 100 || this.pos.x < -200 || this.pos.x > width + 200) {
                    this.init();
                }
            }

            display() {
                push();
                translate(this.pos.x, this.pos.y);
                rotate(this.angle);
                
                if (imgLoaded) {
                    imageMode(CENTER);
                    image(userImg, 0, 0, this.size, this.size);
                } else {
                    // Fotoğraf yoksa teknolojik bir placeholder
                    rectMode(CENTER);
                    noFill();
                    stroke(0, 255, 204, 150);
                    strokeWeight(2);
                    rect(0, 0, this.size * 0.6, this.size * 0.6);
                    fill(0, 255, 204, 50);
                    rect(0, 0, this.size * 0.3, this.size * 0.3);
                }
                pop();
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            video.size(width / vScale, height / vScale);
            prevImg = createImage(video.width, video.height);
        }
    </script>
</body>
</html>
